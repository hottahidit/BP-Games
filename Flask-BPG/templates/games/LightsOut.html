<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lights Out</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 2rem;
      background: #f8f9fa;
      color: #2c3e50;
    }

    h1 {
      margin-bottom: 1rem;
      font-size: 2.5rem;
      color: #2c3e50;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .grid {
      display: grid;
      gap: 6px;
      margin: 1rem auto;
      width: fit-content;
    }

    .cell {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      border: 4px solid #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
    }

    .cell.on {
      background: #ffd54f;
      box-shadow: 0 0 8px rgba(255, 213, 79, 0.6);
      color: #5d4037;
      border-color: grey;
    }

    .cell.off {
      background: black;
      box-shadow: black;
      color: black;
      border-color: grey;
    }

    .title {
      display: inline-block;
      background: #ffffff;
      color: #2c3e50;
      padding: 0.5rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      border: 1px solid #e0e0e0;
    }

    .info {
      margin-bottom: 1rem;
      font-size: 1.5rem;
      color: #2c3e50;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .controls {
      margin-bottom: 1rem;
    }

    select, button {
      padding: 0.5rem 1rem;
      margin: 0 0.25rem;
      border: 1px solid #d1d3d4;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }

    select {
      background: #ffffff;
      color: #2c3e50;
    }

    button {
      background: #5dade2;
      color: #ffffff;
      border-color: #3498db;
    }

    button:hover {
      transform: scale(1.05);
      background: #3498db;
      border-color: #2980b9;
    }
  </style>
</head>
<body>

    <h1><span class="title"> Lights Out </span></h1>

    <div class="info">
        <span><strong>Time:</strong> <span id="timer">0</span> seconds</span>
    </div>

    <div class="controls">
        <div>
          <button onclick="setDifficulty('easy')">Easy</button>
          <button onclick="setDifficulty('medium')">Medium</button>
          <button onclick="setDifficulty('hard')">Hard</button>
        </div>
        </select>
        <button onclick="restart()">Restart</button>
        <button onclick='goToHome()'>Home</button>
    </div>

    <div id="grid" class="grid"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let rows = 10, cols = 10, grid = [];
        let timer = 0, timerInterval = null, timerStarted = false;

        const timerEl = document.getElementById("timer");
        const gridEl = document.getElementById('grid');
        const socket = io();

        function startTimer() {
            if (timerStarted) return;
            timerStarted = true;
            timerInterval = setInterval(() => {
                timer++;
                timerEl.textContent = timer;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function goToHome() {
            window.location.href="/"
        }

        function restart() {
            const difficulty = document.getElementById("difficulty").value;
            fetch(`/games/lights-off-reset?mode=${difficulty}`)
                .then(res => res.json())
                .then(data => {
                    rows = data.rows;
                    cols = data.cols;
                    grid = data.grid;
                    timer = 0;
                    timerStarted = false;
                    timerEl.textContent = "0";
                    renderGrid();
                });
        }

        function renderGrid() {
            gridEl.innerHTML = "";
            gridEl.style.gridTemplateColumns = `repeat(${cols}, 50px)`;
            gridEl.style.gridTemplateRows = `repeat(${rows}, 50px)`;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.classList.add(grid[r][c] ? 'on' : 'off');
                    cell.dataset.row = r;
                    cell.dataset.col = c;

                    cell.addEventListener('click', () => {
                        startTimer();
                        fetch('/games/lights-off-toggle', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({row: r, col: c})
                        })
                        .then(res => res.json())
                        .then(data => {
                            grid = data.grid;
                            renderGrid();
                            if (data.win) {
                                alert("ðŸŽ‰ You Win!");
                                stopTimer();
                            }
                        });
                    });

                    gridEl.appendChild(cell);
                }
            }
        }

        function saveProgress() {
          socket.emit("update_progress", {
            game_name: "lightsout",
            score: timer
          });
        }

        socket.emit("join_game", { game: "lightsout" });

        socket.on("load_progress", (data) => {
          if (data && data.score) {
            console.log("Resumed Lights Out progress:", data);
            alert(`Your best time so far: ${data.score} seconds`);
          }
        });


        fetch('/games/lights-off-reset?mode=easy')
        .then(res => res.json())
        .then(config => {
            rows = config.rows;
            cols = config.cols;
            return fetch('/games/lights-off-toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ row: -1, col: -1 }) // harmless dummy click to trigger state fetch
            });
        })
        .then(res => res.json())
        .then(data => {
            grid = data.grid;
            timer = 0;
            timerStarted = false;
            timerEl.textContent = "0";
            renderGrid();
        });

    </script>
</body>
</html>
