<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minesweeper</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
      background-color: #f5f5f5;
    }

    .grid {
      display: grid;
      gap: 2px;
      margin: 0 auto;
      width: fit-content;
    }

    .cell {
      width: 30px;
      height: 30px;
      background-color: #ccc;
      border: 1px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
    }

    .cell.revealed {
      background-color: #eee;
      cursor: default;
    }

    .cell.mine {
      background-color: red;
      color: white;
      font-weight: bold;
    }

    .cell.flagged {
      background-color: orange;
      color: black;
      font-weight: bold;
    }

    .cell[data-value="1"] { color: blue; }
    .cell[data-value="2"] { color: green; }
    .cell[data-value="3"] { color: red; }
    .cell[data-value="4"] { color: navy; }
    .cell[data-value="5"] { color: maroon; }
    .cell[data-value="6"] { color: turquoise; }
    .cell[data-value="7"] { color: black; }
    .cell[data-value="8"] { color: gray; }

    h1 {
      margin-bottom: 1rem;
    }

    button, select {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 14px;
      cursor: pointer;
    }

    .controls {
      margin-bottom: 1rem;
    }

    .info {
      margin-bottom: 1rem;
      font-size: 18px;
    }
  </style>
</head>
<body>

  <h1>Minesweeper</h1>

  <div class="info">
    <span><strong>Time:</strong> <span id="timer">0</span> seconds</span> |
    <span><strong>Flags Left:</strong> <span id="flags-remaining">0</span></span>
  </div>

  <div class="controls">
    <select id="difficulty">
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
    </select>
    <button onclick="restart()">Restart</button>
    <button onclick="goToHome()">Home</button>
  </div>

  <div id="grid" class="grid"></div>

  <script>
    let rows = 10, cols = 10, totalFlags = 10;
    let flagsPlaced = 0;
    let timer = 0;
    let timerInterval = null;
    let timerStarted = false;

    const timerEl = document.getElementById("timer");
    const flagsRemainingEl = document.getElementById("flags-remaining");
    const gridEl = document.getElementById('grid');

    function startTimer() {
      if (timerStarted) return;
      timerStarted = true;
      timerInterval = setInterval(() => {
        timer++;
        timerEl.textContent = timer;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
    }

    function restart() {
      const difficulty = document.getElementById("difficulty").value;
      window.location.href = `/minesweeper-reset?mode=${difficulty}`;
    }

    function goToHome() {
      window.location.href = '/'
    }

    function renderGrid() {
      gridEl.innerHTML = "";
      gridEl.style.gridTemplateColumns = `repeat(${cols}, 30px)`;
      gridEl.style.gridTemplateRows = `repeat(${rows}, 30px)`;

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');
          cell.dataset.row = r;
          cell.dataset.col = c;

          cell.addEventListener('click', () => {
            startTimer();
            if (cell.classList.contains('flagged') || cell.classList.contains('revealed')) return;

            fetch(`/minesweeper-reveal?row=${r}&col=${c}`)
              .then(res => res.json())
              .then(data => {
                const gameOver = data.some(item => item.game_over);

                data.forEach(item => {
                  const selector = `[data-row="${item.row}"][data-col="${item.col}"]`;
                  const target = document.querySelector(selector);
                  if (!target || target.classList.contains('revealed')) return;

                  target.classList.add('revealed');

                  if (item.value === "-1") {
                    target.classList.add('mine');
                    target.textContent = "ðŸ’£";
                  } else if (item.value !== 0) {
                    target.textContent = item.value;
                    target.setAttribute('data-value', item.value);
                  } else {
                    target.textContent = "";
                  }
                });

                if (gameOver) {
                  alert("ðŸ’¥ Game Over!");
                  stopTimer();
                }

                checkWin();
              });
          });

          cell.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (cell.classList.contains('revealed')) return;

            if (cell.classList.contains('flagged')) {
              cell.classList.remove('flagged');
              cell.textContent = "";
              flagsPlaced--;
            } else if (flagsPlaced < totalFlags) {
              cell.classList.add('flagged');
              cell.textContent = "ðŸš©";
              flagsPlaced++;
            }

            flagsRemainingEl.textContent = totalFlags - flagsPlaced;
          });

          gridEl.appendChild(cell);
        }
      }
    }

    function checkWin() {
      const allCells = document.querySelectorAll('.cell');
      const revealed = [...allCells].filter(cell => cell.classList.contains('revealed')).length;
      const total = rows * cols;

      if (revealed === total - totalFlags) {
        alert("ðŸŽ‰ You Win!");
        stopTimer();
        allCells.forEach(cell => {
          if (!cell.classList.contains('revealed') && !cell.classList.contains('flagged')) {
            const row = cell.dataset.row;
            const col = cell.dataset.col;
            fetch(`/minesweeper-reveal?row=${row}&col=${col}`)
              .then(res => res.json())
              .then(data => {
                data.forEach(item => {
                  if (item.value === "-1") {
                    const target = document.querySelector(`[data-row="${item.row}"][data-col="${item.col}"]`);
                    if (target && !target.classList.contains('revealed')) {
                      target.classList.add('revealed');
                      target.textContent = "ðŸ’£";
                      target.style.backgroundColor = 'dodgerblue';
                      target.style.color = 'white';
                    }
                  }
                });
              });
          }
        });
      }
    }

    // Initial load: fetch config from backend
    fetch("/minesweeper-info")
      .then(res => res.json())
      .then(data => {
        rows = data.rows;
        cols = data.cols;
        totalFlags = data.mines;
        flagsPlaced = 0;
        timer = 0;
        timerStarted = false;
        timerEl.textContent = "0";
        flagsRemainingEl.textContent = totalFlags;
        renderGrid();
      });
  </script>
</body>
</html>

